#!/usr/bin/env bash

# determine toplevel directory of x10 installation
ME=`readlink -f "$0"`
MYDIR=`dirname "$ME"`
X10_TOP="${MYDIR}/../.."

[ -z "$JAVA" ] && JAVA="java"

# prepare classpath
classpath=""
append_classpath() {
	if [ -n "${classpath}" ]; then
		classpath="${classpath}:$1"
	else
		classpath="$1"
	fi
}
append_classpath "${X10_TOP}/x10.compiler/classes"
append_classpath "${X10_TOP}/x10.runtime/classes"
append_classpath "${X10_TOP}/x10.common/classes"
append_classpath "${X10_TOP}/x10.constraints/classes"
append_classpath "${X10_TOP}/x10.dist/lib/lpg.jar"
append_classpath "${X10_TOP}/x10.firm/classes"
append_classpath "${X10_TOP}/jFirm/classes"
append_classpath "${X10_TOP}/liboo/classes"
append_classpath "${X10_TOP}/jFirm/lib/jna.jar"

JNA_LIBRARY_PATH="${X10_TOP}/libfirm/build/debug"
JNA_LIBRARY_PATH="${JNA_LIBRARY_PATH}:${X10_TOP}/liboo/build"
# Some how we can not use -Djna.library.path= as java arguments, otherwise
# liboo won't find the referenced libfirm librarye (not jna can't find it
# but dlopen while opening liboo.so)
export LD_LIBRARY_PATH="$JNA_LIBRARY_PATH"

# Execute compiler
args="-extclass x10firm.ExtensionInfo -sourcepath ${X10_TOP}/x10.dist/lib/x10.jar"
command="$JAVA -Xmx512m -ea -classpath ${classpath} ${java_args} polyglot.main.Main"
$command $args "$@"

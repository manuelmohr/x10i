package x10firm.types;

import java.util.HashMap;
import java.util.Map;

import firm.ClassType;
import firm.Firm;
import firm.Ident;

import polyglot.types.Context;
import polyglot.types.Name;
import polyglot.types.PrimitiveType;
import polyglot.types.Type;
import x10.types.X10ClassDef;
import x10.types.X10MethodDef;
import x10.types.X10TypeSystem_c;
import x10.visit.StaticNestedClassRemover;
import x10firm.visit.X10FirmTranslator;

public class X10FirmTypeSystem_c extends X10TypeSystem_c {
	
	public static final String X10_BOOLEAN = "boolean";
	public static final String X10_CHAR    = "char";
	public static final String X10_BYTE    = "byte";
	public static final String X10_SHORT   = "short";
	public static final String X10_INT     = "int"; 
	public static final String X10_LONG    = "long";
	public static final String X10_FLOAT   = "float";
	public static final String X10_DOUBLE  = "double";
	
    private Map<String, firm.Type> tcache = new HashMap<String, firm.Type>();
    
    public X10FirmTypeSystem_c() {
    	Firm.init(); 
    }
    
    private void addType(String tname, firm.Type type) {
    	assert(tcache.containsKey(tname));
    	tcache.put(tname, type); 
    }
    
    public firm.Type getFirmType(String tname) {
    	assert(tcache.containsKey(tname)); 
    	return tcache.get(tname); 
    }
    
    private firm.Type createPrimitiveType(firm.Mode mode) {
    	return new firm.PrimitiveType(mode); 
    }

    private void initPrimitiveType() {
    	
    	firm.Type x10_boolean = createPrimitiveType(firm.Mode.getb());
    	 // unsigned short for x10_char -> Unicode
    	firm.Type x10_char    = createPrimitiveType(firm.Mode.getHu());
    	firm.Type x10_byte    = createPrimitiveType(firm.Mode.getBs());
    	firm.Type x10_short   = createPrimitiveType(firm.Mode.getHs());
    	firm.Type x10_int     = createPrimitiveType(firm.Mode.getIs());
    	firm.Type x10_long    = createPrimitiveType(firm.Mode.getLs());
    	firm.Type x10_float   = createPrimitiveType(firm.Mode.getF());
    	firm.Type x10_double  = createPrimitiveType(firm.Mode.getD());
    	
    	addType("boolean", x10_boolean);
    	addType("char",    x10_byte);
    	addType("short",   x10_short);
    	addType("int",     x10_int);
    	addType("long",    x10_long);
    	addType("float",   x10_float);
    	addType("double",  x10_double);
    }
    
    public void declFirmClass(X10ClassDef cDef) {
    	String cname = X10FirmTranslator.getFullClassName(cDef.asType());
    	
    	firm.Type cType 		= new firm.ClassType(new firm.Ident(cname));
    	firm.Type cPointerType 	= new firm.PointerType(cType);
    	
    	addType(cname, cPointerType); 
    }
    
    public void declFirmStruct(X10ClassDef cDef) {
    	// TODO: Implement me
    }
    
    public void declFirmMethod(X10MethodDef mDef) {
    	
    }
	
	public Context emptyContext() {
		return new X10FirmContext_c(this);
	}
}
